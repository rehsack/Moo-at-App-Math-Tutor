\documentclass[ngerman,xcolor={table,dvipsnames},scriptsizeer,compress,hyperref={bookmarks,colorlinks}]{beamer}

\usepackage{url}
\usepackage{listings}
\usepackage[latin9]{inputenc}
\usepackage{xcolor,textcomp}
%\usepackage{auto-pst-pdf}
\usepackage{pstricks}
\usepackage{pst-node}
\usepackage{pst-uml}
\usepackage{pst-tree}
\usepackage{tabularx,threeparttable}
\usepackage{hyperref}

\title{Moo in practice - App::Math::Tutor}
\author{Jens Rehsack}
\date{2014}

\usetheme[secheader]{Boadilla}
\setbeamertemplate{navigation symbols}{}

\newcommand{\perlfilename}[1]{{\color{cyan}{\textit{\begingroup \urlstyle{sf}\Url{#1}}}}}
\newcommand{\xsfilename}[1]{{\color{olive}{\textit{\begingroup \urlstyle{sf}\Url{#1}}}}}
\newcommand{\hfilename}[1]{{\color{olive}{\textit{\begingroup \urlstyle{sf}\Url{#1}}}}}
\newcommand{\cfilename}[1]{{\color{magenta}{\textit{\begingroup \urlstyle{sf}\Url{#1}}}}}

\makeatletter
\makeatother

%\newcommand{\mypart}[1]{\part{#1}\frame{\partpage \tableofcontents}}
\newcommand{\mysection}[1]{\section{#1}\frame{\frametitle{Overview}\tableofcontents[sectionstyle=show/shaded,subsectionstyle=show/shaded/shaded]}}
\newcommand{\mysubsection}[1]{\subsection{#1}\frame{\frametitle{Overview}\tableofcontents[sectionstyle=show/shaded,subsectionstyle=show/shaded/shaded]}}
\newcommand{\mysubsubsection}[1]{\subsubsection{#1}\frame{\frametitle{Overview}\tableofcontents[sectionstyle=show/shaded,subsectionstyle=show/shaded/shaded]}}

\begin{document}

\psset{angleA=90,angleB=-90}
\lstset{language=Perl,
        basicstyle=\ttfamily,
        keywordstyle=\color{Maroon},
        commentstyle=\color{Blue}, 
        stringstyle=\color{Green},
        showstringspaces=false}

%\AtBeginSection[]{\begin{frame}<beamer> \frametitle{Overview} \tableofcontents[current, currentsubsection] \end{frame}}
%\AtBeginSubsection[]{\begin{frame}<beamer> \frametitle{Overview} \tableofcontents[current, currentsubsection] \end{frame}}
\AtBeginPart{\begin{frame}<beamer> \frametitle{Overview} \partpage \tableofcontents[current] \end{frame}}

\frame{\maketitle}

\part{Introduction}

\section{Introduction}

\begin{frame}[fragile]
\frametitle{Audience}
\begin{block}<1->{Audience}
\begin{itemize}
\item Developer who wants to create or improve Perl5 software
\item Developer who wants to learn how to develop modern OO with Perl5
\item Developer who're interested in developing mathematical exercises
\end{itemize}
\end{block}

\begin{block}<2->{Prerequisites of the Audience}
Following knowledge is expected:
\begin{itemize}
\item General knowledge about object oriented programming or concepts
      \begin{itemize}
      \item methods
      \item attributes
      \item classes
      \item objects
      \item inheritance
      \item roles
      \end{itemize}
\item slightly above basic Perl experience
\uncover<3->{\item ever heard of Smalltalk and it's OO-concept is a strong bonus}
\end{itemize}
\end{block}
\end{frame}

\begin{frame}[fragile]
\frametitle{Motivation}

\begin{block}<1->{Moo and App::Math::Tutor}
\begin{itemize}
\item real world examples over far-fetched conceptuals
\item MooX::Cmd, MooX::Options and MooX::ConfigFromFile provide way more features and flexibility than either
      \begin{itemize}
      \item App::Cmd with Getopt::Long::Descriptive
      \item MooseX::App::Cmd along with corresponding MooseX warppers around related stuff
      \end{itemize}
\item $ 2^{nd} $ generation of modern OO in Perl5
\end{itemize}
\end{block}

\begin{block}<2->{App::Math::Tutor}
\begin{itemize}
\item Allow parents help their children improving their mathematical skills
\item Add support for exercise types as children require
\item provide extensible design to allow easy augment of exercise
\uncover<3->{\item \textbf{Goal:} Improve to Web-Service, eg. by mapping MooX::Cmd to URI path and MooX::Options to GET parameters}
\end{itemize}
\end{block}

\end{frame}

\part{Moo basics}

\section{Attributes}

\begin{frame}[fragile]

\begin{block}<1->{Attributes in Moo}
\begin{lstlisting}[language=Perl,inputencoding=latin9,escapeinside={(*@}{@*)}]
package VulgarFraction;

use Moo::Role;

has(*@\pnode(0,0){A}{}@*) nume(*@\pnode(0,0){B}{}@*)rator => ( is => "(*@\pnode(0,0){D}{}@*)ro", (*@\pnode(0,0){F}{}@*)required => 1 );
has denom(*@\pnode(0,0){C}{}@*)inator => ( is => "(*@\pnode(0,0){E}{}@*)ro", required => (*@\pnode(0,0){G}{}@*)1 );

1;
\end{lstlisting}
\end{block}

\begin{itemize}
\uncover<2->{\item use \rnode{a}{"has"} keyword to define a attribute}
\uncover<3->{\item attributes \rnode{b}{"numerator"} and \rnode{c}{"denominator"}}
\uncover<4->{\item attributes are \rnode{d}{immutable} \uncover<5->{and \rnode{f}{required}}}
\uncover<2>{\nccurve[linecolor=olive]{->}{a}{A}}
\uncover<3>{\nccurve[linecolor=teal]{->}{b}{B}\nccurve[linecolor=teal]{->}{c}{C}}
\uncover<4>{\nccurve[linecolor=blue]{->}{d}{D}\nccurve[linecolor=blue]{->}{d}{E}}
\uncover<5>{\nccurve[linecolor=cyan]{->}{f}{F}\nccurve[linecolor=cyan]{->}{f}{G}}
\end{itemize}

\end{frame}

\begin{frame}[fragile]

\begin{block}<1->{Attribute options I}
\begin{description}
\item[is] \textbf{required} behavior description
    \begin{description}
    \uncover<2->{\item[ro] defines the attribute is read only}
    \uncover<3->{\item[rw] defined the attribute is read-/writable}
    \uncover<4->{\item[lazy] defines the attribute is read only with a lazy initialization}
    \uncover<5->{\item[rwp] defines the attribute being read only for public and read-/writable for private use}
    \end{description}
\uncover<6->{\item[required] when set to a true value, attribute must be passed on instantiation}
\uncover<7->{\item[isa] defines a subroutine (\texttt{coderef}) which is called to validate values to set}
\uncover<8->{\item[coerce] defines a subrouting (\texttt{coderef}) which forces attribute values}
\uncover<9->{\item[handles] defines a \textbf{role} or subroutines (\texttt{coderef}) this attribute handles}
\end{description}
\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}<1->{Attribute options II}
\begin{description}
\item[trigger] takes a subroutine (\texttt{coderef}) which called anytime the attribute is set \\
    \uncover<2->{\textbf{special}: the value of $ 1 $ means to generate a (\texttt{coderef}) which calles the method \texttt{\_trigger\_\$\{attr\_name\}} (This is called \textit{attribute shortcut})}
\uncover<3->{\item[default] subroutine (\texttt{coderef}) which is called to initialize an attribute}
\uncover<4->{\item[predicate] takes a method name (\texttt{string}) which will return true if an attribute has a value (supports \textit{attribute shortcut})}
\uncover<5->{\item[builder] takes a method name (\texttt{string}) which is called to initialize an attribute (supports \textit{attribute shortcut})}
\uncover<6->{\item[clearer] takes a method name (\texttt{string}) which will clear the attribute (supports \textit{attribute shortcut})}
\uncover<7->{\item[lazy] takes a bool value which delays attribute initialization to first time it's grabbed when \texttt{true}}
\end{description}
\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}<1->{Attribute options III}
\begin{description}
\item[reader] takes a method name for another than default getter name (\texttt{\_get\_\$\{attr\_name\}} instead of \texttt{\$\{attr\_name\}} to get some Java smell)
\uncover<2->{\item[writer]  takes a method name for another than default setter name (\texttt{\_set\_\$\{attr\_name\}} instead of \texttt{\$\{attr\_name\}} to get some C++ smell)}
\uncover<3->{\item[weak\_ref] should be set to a true value when circular references are possible by attribute value (to avoid leaks)}
\uncover<4->{\item[init\_arg] Takes the name of the key to look for at instantiation time of the object. A common use of this is to make an underscored attribute have a non-underscored initialization name. undef means that passing the value in on instantiation is ignored.}
\uncover<5->{\item[moosify] Takes either a coderef or array of coderefs which is meant to transform the given attributes specifications if necessary when upgrading to a Moose role or class. You shouldn't need this by default, but is provided as a means of possible extensibility.}
\end{description}
\end{block}

\end{frame}

\section{Methods}

\begin{frame}[fragile]

\begin{block}<1->{Methods in Moo I}
\scriptsize
\begin{lstlisting}[language=Perl,inputencoding=latin9,escapeinside={(*@}{@*)}]
package VulgarFraction;

use Moo;
use overload "''" => "_stringify",
             "0+" => "_numify",
             "<>" => "_num_compare",
             "bool" => sub { 1 };

has numerator => ( is => "ro", required => 1 );
has denominator => ( is => "ro", required => 1,
  isa => quote_sub(q{$_[0] != 0 or die "Not != 0"}) );

sub _stringify { my $self = shift;
  return sprintf("\\frac{%s}{%s}",
  $self->numerator, $self->denominator); }

sub _numify { $_[0]->numerator / $_[0]->denominator; }
...
\end{lstlisting}
\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}<1->{Methods in Moo II}
\scriptsize
\begin{lstlisting}[language=Perl,inputencoding=latin9,escapeinside={(*@}{@*)}]
package Rationale;

use Moo;

extends "VulgarFraction";

has digits => ( is => "ro", required => 1 );

sub _stringify {
  my $digits = $_[0]->digits;
  sprintf("%.${digits}g", $_[0]->_numify); }

\end{lstlisting}
\end{block}

\onslide<2->{
\begin{itemize}
\item nothing like \texttt{MooseXX:Declare} - pure Perl5 keywords are enough for plain methods
\end{itemize}
}

\end{frame}

\begin{frame}[fragile]

\begin{block}<1->{Method Modifiers}
\begin{description}
\item[before] \texttt{before method(s) => sub \{ \ldots \}} \\
before is called before the method it is modifying. Its return value is totally ignored.
\item[after] \texttt{after method(s) => sub \{ \ldots \}} \\
after is called after the method it is modifying. Its return value is totally ignored.
\item[around] \texttt{around method(s) => sub \{ \ldots \}} \\
around is called instead of the method it is modifying. The method you're overriding is passed as \texttt{coderef} in the first argument.
\end{description}
\end{block}

\begin{itemize}
\uncover<2->{\item supersedes \texttt{\$self->SUPER::foo(@\_)} syntax}
\uncover<3->{\item allows multiple modifiers in single namespace}
\uncover<4->{\item cleaner interface than SUPER}
\uncover<5->{\item ensures that inherited methods invocation happens right (mostly - remember around)}
\end{itemize}

\end{frame}

\begin{frame}[fragile]

\begin{block}<1->{Methods Modifiers - around avoid calling \texttt{\$orig}}
\scriptsize
\begin{lstlisting}[language=Perl,inputencoding=latin9,escapeinside={(*@}{@*)}]
package RomanExercise;

use Moo::Role;

with "App::Math::Tutor::Role::Natural";

{ package RomanNumber;
  use Moo;
  extends "NaturalNumer"; # derives overloading!
  sub _stringify { ... } }

around "_guess_natural_number" => sub {
    my $orig    = shift;
    my $max_val = $_[0]->format;
    my $value   = int( rand( $max_val - 1 ) ) + 1;
    return RomanNum->new( value => $value );
};
\end{lstlisting}
\end{block}

\begin{itemize}
\item captures control
\item receives responsibility
\item runtime of modified method completely eliminated
\end{itemize}

\end{frame}

\begin{frame}[fragile]

\begin{block}<1->{Methods Modifiers - around modifying \texttt{\$orig} return value}
\scriptsize
\begin{lstlisting}[language=Perl,inputencoding=latin9,escapeinside={(*@}{@*)}]
package RomanExercise;

use Moo::Role;

with "App::Math::Tutor::Role::Natural";

{ package RomanNumber;
  use Moo;
  extends "NaturalNumber"; # derives overloading!
  sub _stringify { ... } }

around "_guess_natural_number" => sub {
    my $orig = shift;
    my $num  = $orig->(@_);
    return RomanNum->new( value => $num->value );
};
\end{lstlisting}
\end{block}

\begin{itemize}
\item modifies only required part
\item leaves most responsibility in modified method
\item runtime of modified method added to this method's runtime
\end{itemize}

\end{frame}

\part{Math Tutor}

\section{Structure}

\begin{frame}[fragile]

\begin{block}<1->{Frontend (dictated by MooX::Cmd)}
\scriptsize
\def\psedge#1#2{\ncdiagg[nodesep=3pt,angleA=180,armA=0]{#2}{#1}}
\pstree[treemode=R,levelsep=*0.2cm,treesep=0.5cm]{\Tr{App::Math::Tutor}}{%
    \pstree[levelsep=*0.2cm]
	{\Tr{App::Math::Tutor::Cmd::VulFrac}}
	{\Tr{App::Math::Tutor::Cmd::VulFrac::Cmd::Add} \Tr{App::Math::Tutor::Cmd::VulFrac::Cmd::Mul} \Tr{App::Math::Tutor::Cmd::VulFrac::Cmd::Cast}}
    \pstree[levelsep=*0.2cm]
	{\Tr{App::Math::Tutor::Cmd::Natural}}
	{\Tr{App::Math::Tutor::Cmd::Natural::Cmd::Add} \Tr{App::Math::Tutor::Cmd::Natural::Cmd::Mul}}
    \pstree[levelsep=*0.2cm]
	{\Tr{App::Math::Tutor::Cmd::Roman}}
	{\Tr{App::Math::Tutor::Cmd::Roman::Cmd::Add} \Tr{App::Math::Tutor::Cmd::Roman::Cmd::Cast}}
    \pstree[levelsep=*0.2cm]
	{\Tr{App::Math::Tutor::Cmd::Unit}}
	{\Tr{App::Math::Tutor::Cmd::Unit::Cmd::Add} \Tr{App::Math::Tutor::Cmd::Unit::Cmd::Mul} \Tr{App::Math::Tutor::Cmd::Unit::Cmd::Cast}}
}

\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}<1->{Exercise groups}
\begin{description}
\item[App::Math::Tutor::Cmd::VulFrac] Exercises in vulgar fraction calculation
\item[App::Math::Tutor::Cmd::Natural] Exercises in calculations using natural numbers
\item[App::Math::Tutor::Cmd::Roman] Exercises in calculations using natural numbers, but show them using roman number encoding (exercises and solutions)
\item[App::Math::Tutor::Cmd::Unit] Exercises in calculations using units (times, currency, \ldots)
\item[App::Math::Tutor::Cmd::Power] Exercises in calculations of power mathematics
\item[App::Math::Tutor::Cmd::Polynom] Exercises for polynomial mathematics (Zero of a function, Vertex, \ldots)
\end{description}
\end{block}

\end{frame}

\begin{frame}[fragile]

\begin{block}<1->{Typical Exercise design}
\begin{pspicture}(12,7)%\psgrid
\scriptsize
 \rput(8.5,6.25){\rnode{A}{%
  \umlClass{App::Math::Tutor::Cmd::VulFrac::Cmd::Add}{\hline
 \_build\_exercise() : exercise
 }}}
 \rput(8.5,4.5){\rnode{B}{%
  \umlClass{App::Math::Tutor::Role::VulfracExercise}{
  format\\\hline
  \\\hline
 }}}
 \rput(3,1){\rnode{C}{%
  \umlClass{App::Math::Tutor::Role::Vulfrac}{\hline
 \_check\_vulgar\_fraction() : bool \\
 \_guess\_vulgar\_fraction() : VulFrac \\
 get\_vulgar\_fractions() : [ VulFrac ]
 }}}
 \rput(2.5,5){\rnode{D}{%
  \umlClass{VulFrac}{
  num\\
  denum\\
  \hline
  \_stringify() : Str \\
  \_numify() : Num \\
  \_num\_compare() : Int \\
  \_euklid() : Int \\
  \_gcd() : Int \\
  \_reduce() : VulFrac \\
  \_reciprocal() : VulFrac \\
 }}}
 \rput(9,1.5){\rnode{E}{%
  \umlClass{App::Math::Tutor::Role::Exercise}{
  exercise : lazy \\
  \# \{ section, caption, label, \\
  \#    header, challenges, solutions \}\\
  output\_name : lazy\\
  template\_filename : lazy\\
  \hline
  \_build\_exercise() = 0 : exercise\\
  \_build\_output\_name() : Str\\
  \_build\_template\_filename() = 0 : Str\\
  execute()
 }}}
\end{pspicture}
\ncN{B}{A} % App::Math::Tutor::Cmd::VulFrac::Cmd::Add -> App::Math::Tutor::Role::VulfracExercise
\ncputicon[npos=0]{umlV}
\ncNXE{C}{B} % App::Math::Tutor::Role::VulfracExercise -> App::Math::Tutor::Role::Vulfrac
\ncputicon[npos=0]{umlV}
\ncNXW{E}{B} % App::Math::Tutor::Role::VulfracExercise -> App::Math::Tutor::Role::Exercise
\ncputicon[npos=0]{umlV}
\ncSXE{D}{B}
\ncputicon[npos=0]{umlAgreg}
\ncline[linestyle=dashed]{D}{A}
\end{block}

\end{frame}

%\resizebox{skalierungsfaktor\textwidth}{!}{\includegraphics*{dateiname}}

\begin{frame}[fragile]

\begin{block}<1->{Derived Exercise design}
\resizebox{\textwidth}{!}{
\begin{pspicture}(16,10)%\psgrid
\scriptsize
 \rput(13,9){\rnode{A}{%
  \umlClass{App::Math::Tutor::Cmd::Roman::Cmd::Add}{\hline
 \_build\_exercise() : exercise
 }}}
 \rput(13,6){\rnode{B}{%
  \umlClass{App::Math::Tutor::Role::NaturalExercise}{
  format\\\hline
  \\\hline
 }}}
 \rput(4,3.5){\rnode{C}{%
  \umlClass{App::Math::Tutor::Role::Roman}{\hline
 around => \_guess\_natural\_number() : Roman \\
 }}}
 \rput(4,1){\rnode{D}{%
  \umlClass{App::Math::Tutor::Role::Natural}{\hline
 \_check\_natural\_number() : bool \\
 \_guess\_natural\_number() : Natural \\
 get\_natural\_number() : [ Natural ]
 }}}
 \rput(4,9){\rnode{E}{%
  \umlClass{RomanNum}{
  \hline
  \_stringify() : Str \\
 }}}
 \rput(4,6){\rnode{F}{%
  \umlClass{Natural}{
  value\\
  \hline
  \_stringify() : Str \\
  \_numify() : Num \\
  \_num\_compare() : Int \\
 }}}
 \rput(13,2){\rnode{G}{%
  \umlClass{App::Math::Tutor::Role::Exercise}{
  exercise : lazy \\
  \# \{ section, caption, label, \\
  \#    header, challenges, solutions \}\\
  output\_name : lazy\\
  template\_filename : lazy\\
  \hline
  \_build\_exercise() = 0 : exercise\\
  \_build\_output\_name() : Str\\
  \_build\_template\_filename() = 0 : Str\\
  execute()
 }}}
\end{pspicture}
\ncN{B}{A} % App::Math::Tutor::Cmd::Roman::Cmd::Add -> App::Math::Tutor::Role::NaturalExercise
\ncputicon[npos=0]{umlV}
\ncEXN{D}{B} % App::Math::Tutor::Role::NaturalExercise -> App::Math::Tutor::Role::Natural
\ncputicon[npos=0]{umlV}
\ncN{G}{B} % App::Math::Tutor::Role::NaturalExercise -> App::Math::Tutor::Role::Exercise
\ncputicon[npos=0]{umlV}
\ncE{F}{B}
\ncputicon[npos=0]{umlAgreg}
\ncline[linestyle=dashed,linecolor=blue]{E}{A}
\ncN[linecolor=blue]{D}{C} % App::Math::Tutor::Role::Roman -> App::Math::Tutor::Role::Natural
\ncputicon[npos=0,linecolor=blue]{umlV}
\ncEVE[linecolor=blue]{C}{A} % App::Math::Tutor::Cmd::Roman::Cmd::Add -> App::Math::Tutor::Role::Roman
\ncputicon[npos=0,linecolor=blue]{umlV}
\ncN[linecolor=blue]{F}{E} % RomanNum -> Natural
\ncputicon[npos=0,linecolor=blue]{umlV}
} % end of resizebox
\end{block}

\end{frame}

\begin{frame}[t,fragile]

\begin{block}<1->{Improving design}
\begin{itemize}
\item introduce factories
\uncover<2->{\item add lazy factory attribute \uncover<3->{(allowes overriding factory to use by \texttt{around}'ing builder)}}
\uncover<4->{\item separate \texttt{number} classes (type system, but \textbf{no} \texttt{MooseX::Types})}
\uncover<5->{\item approval for reasonable exercise value should be part of factory}
\uncover<6->{\item approval for valid number should be \texttt{coerce}d (\texttt{trigger}?)}
\end{itemize}
\end{block}

\begin{block}<7->{Design history}
\begin{itemize}
\item I started with just vulgar fraction exercises
\uncover<8->{\item Design covered exactly those needs}
\end{itemize}
\end{block}

\begin{block}<9->{Design futury}
\begin{itemize}
\item Modern Perl-OO allowes easy refactoring to apply above improvements
\end{itemize}
\end{block}

\end{frame}

\section{conclusion}

\begin{frame}[fragile]

\begin{block}<1->{Conclusion}
\begin{itemize}
\item lazy attributes allow designing a multi-stage initialization phase
\end{itemize}
\end{block}

\end{frame}



%\begin{frame}[fragile]

%\begin{block}<n->{}
%\begin{itemize}
%\item
%\end{itemize}
%\end{block}

%\end{frame}

\part{Finish}

% RESOURCES
\begin{frame}[fragile]
\frametitle{Resources}
\begin{block}<1->{Software}
\url{http://www.i-scream.org/libstatgrab/} \\
\url{http://search.cpan.org/dist/Unix-Statgrab/} \\
\url{https://metacpan.org/module/Unix::Statgrab}
\end{block}

\begin{block}<2->{Mailing List}
\url{https://lists.i-scream.org/pipermail/users/} \\
\url{users@i-scream.org}
\end{block}

\begin{block}<3->{IRC}
\url{irc://irc.freenode.net/#libstatgrab}
\end{block}
\end{frame}

% THANKS
\begin{frame}[fragile]
\frametitle{Thank You}
\begin{block}<1->{Thank you}
\begin{itemize}
\uncover<2->{\item Tim Bishop for caring for high quality release}
\uncover<3->{\item H. Merijn Brand for doing additional tests on more exotic platforms}
\uncover<4->{\item Reini Urban for proving on commodity hardware for being sane}
\end{itemize}
\end{block}
\begin{block}<5->{Questions?}
Jens Rehsack \textless{}\href{mailto:rehsack@cpan.org}{rehsack@cpan.org}\textgreater{}
\end{block}
\end{frame}

%\begin{frame}[fragile]
%\frametitle{}
%\begin{block}<1->{}
%\begin{itemize}
%\item 
%\end{itemize}
%\end{block}
%\end{frame}

\end{document}

